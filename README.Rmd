---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# deltapif <img src="man/figures/logo.png" align="right" height="127" alt="The logo of the deltapif method showing an observed and a counterfactual population with coloured squares. A line partitions them in the middle. The image reads 'deltapif'." />

<!-- badges: start -->
[![CRAN status](https://www.r-pkg.org/badges/version/deltapif)](https://CRAN.R-project.org/package=deltapif)
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![R-CMD-check](https://github.com/RodrigoZepeda/deltapif/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/RodrigoZepeda/deltapif/actions/workflows/R-CMD-check.yaml)
[![Codecov test coverage](https://codecov.io/gh/RodrigoZepeda/deltapif/graph/badge.svg)](https://app.codecov.io/gh/RodrigoZepeda/deltapif)
<!-- badges: end -->

The `deltapif` R package calculates **Potential Impact Fractions (PIF) and Population Attributable Fractions (PAF) for aggregated data**. It uses the delta method to derive confidence intervals, providing a robust approach for quantifying the burden of disease attributable to risk factors and the potential impact of interventions.

## Installation

You can install the development version of deltapif from [GitHub](https://github.com/RodrigoZepeda/deltapif) with:

```{r, eval = FALSE}
remotes::install_github("RodrigoZepeda/deltapif")
```


## Overview

The package provides two core functions:

  + `paf()`: Calculates the Population Attributable Fraction.
  
  + `pif()`: Calculates the Potential Impact Fraction.

Both functions require:

  + `p`: The exposure prevalence in the population.
  
  + `beta`: The log-relatieve risk coefficient(s) (or a value from which the relative risk can be obtained).
  
  + `var_p`, `var_beta`: Variances for the prevalence and log-relative risk estimates.

The `pif()` function additionally requires:

+ `p_cft`: The counterfactual exposure prevalence under an intervention scenario.

> **Note** A key assumption of the delta method implementation is that the relative risk and exposure prevalence estimates are independent (i.e., derived from different studies or populations).


## Usage

Example: Population Attributable Fraction (PAF)

[Lee et al. (2022)](https://doi.org/10.1001/jamanetworkopen.2022.19672) estimated the fraction of dementia cases attributable to smoking in the US. They reported:

  + A relative risk of 1.59 (95% CI: 1.15, 2.20)

  + A smoking prevalence of 8.5%

The point estimate of the PAF can be calculated using [Levin's formula](https://doi.org/10.1016/j.gloepi.2021.100062):

```{r}
library(deltapif)

paf(p = 0.085, beta = 1.59, quiet = TRUE)
```

#### Incorporating Uncertainty

To calculate confidence intervals, we need the variance of the log-relative risk. The variance can be derived from the confidence interval following the [Cochrane Handbook](https://handbook-5-1.cochrane.org/chapter_7/7_7_3_2_obtaining_standard_deviations_from_standard_errors_and.htm):

```{r}
var_log_rr <- ((log(2.20) - log(1.15)) / (2 * 1.96))^2
var_log_rr
```

We then provide the log-relative risk (`log(1.59)`) and its variance to `paf()`, specifying the `rr_link` as `exp` to convert the coefficient to a relative risk by exponentiating the log. Since the prevalence variance was not reported, we set `var_p = 0`.

```{r}
paf(
  p = 0.085, 
  beta = log(1.59), 
  var_beta = var_log_rr, 
  var_p = 0, 
  rr_link = exp
)
```

The results match those reported by Lee et al.: **PAF = 4.9% (95% CI: 1.3–9.3)**.

### Example: Potential Impact Fraction (PIF)

[Lee et al. (2022)](https://doi.org/10.1001/jamanetworkopen.2022.19672) also considered a scenario reducing smoking prevalence by 15% (from 8.5% to 7.225%). The PIF for this intervention is:

```{r}
pif(
  p = 0.085, 
  p_cft = 0.085 * (1 - 0.15), # 15% reduction
  beta = log(1.59), 
  var_beta = var_log_rr, 
  var_p = 0, 
  rr_link = exp
)
```

This result is consistent with the reported estimate: **PIF = 0.7% (95% CI: 0.2–1.4)**.

## Learn More

+ For more detailed examples, including multi-category risk factors, and combining fractions into a total see the [package's website](https://rodrigozepeda.github.io/deltapif/).

+ See the vignette: [Introduction to deltapif](https://rodrigozepeda.github.io/deltapif/articles/Introduction.html)

## Contributing

Contributions are welcome! Please file issues and pull requests on [GitHub](https://github.com/RodrigoZepeda/deltapif).
