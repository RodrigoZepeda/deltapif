% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/11-weighted_adjusted.R
\name{weighted_adjusted_fractions}
\alias{weighted_adjusted_fractions}
\title{Weighted Adjusted Fractions}
\usage{
weighted_adjusted_fractions(
  pif1,
  ...,
  weights = NULL,
  pif_total_link = "log-complement",
  pif_total_link_inv = NULL,
  pif_total_link_deriv = NULL,
  pif_ensemble_link = "identity",
  pif_ensemble_link_inv = NULL,
  pif_ensemble_link_deriv = NULL,
  var_weights = 0,
  var_pif_weights = NULL,
  var_p = NULL,
  var_beta = NULL,
  conf_level = 0.95,
  label_ensemble = NULL,
  label_sum = NULL,
  quiet = FALSE
)
}
\arguments{
\item{pif1}{A potential impact fraction (class \code{pif_class}). This is
the first of the individual fractions to be adjusted.}

\item{...}{The remaining potential impact fractions (class \code{pif_class}).
All fractions must be of the same type (all \code{PIF} or all \code{PAF}).}

\item{weights}{Weights for the ensemble (\code{pif_ensemble}).
Passed directly to \code{\link[=pif_ensemble]{pif_ensemble()}} / \code{\link[=paf_ensemble]{paf_ensemble()}}.
Defaults to \code{NULL} (equal weights of 1 for each fraction).}

\item{pif_total_link}{Link to pass to \code{pif_total} in the denominator
of the adjustment}

\item{pif_total_link_inv}{Inverse of the link to pass to \code{pif_total} in the denominator
of the adjustment}

\item{pif_total_link_deriv}{Derivative of the link to pass to \code{pif_total} in the denominator
of the adjustment}

\item{pif_ensemble_link}{Link to pass to \code{pif_ensemble} in the numerator
of the adjustment}

\item{pif_ensemble_link_inv}{Inverse of the link to pass to \code{pif_ensemble} in the numerator
of the adjustment}

\item{pif_ensemble_link_deriv}{Derivative of the link to pass to \code{pif_ensemble} in the numerator
of the adjustment}

\item{var_weights}{Covariance structure for \code{weights}.
Passed directly to \code{\link[=pif_ensemble]{pif_ensemble()}} / \code{\link[=paf_ensemble]{paf_ensemble()}}.
Defaults to \code{0}.}

\item{var_pif_weights}{Covariance matrix between individual
fractions and \code{weights}. Passed to \code{\link[=pif_ensemble]{pif_ensemble()}} /
\code{\link[=paf_ensemble]{paf_ensemble()}}. Defaults to \code{NULL}.}

\item{var_p}{Covariance matrix for the prevalence parameters \code{p} across
all fractions. Passed to \code{\link[=cov_total_pif]{cov_total_pif()}} when computing cross-covariances.
Defaults to \code{NULL}.}

\item{var_beta}{Covariance matrix for the relative-risk parameters \code{beta}
across all fractions. Passed to \code{\link[=cov_total_pif]{cov_total_pif()}} when computing
cross-covariances. Defaults to \code{NULL}.}

\item{conf_level}{Confidence level for the confidence interval (default 0.95).}

\item{label_ensemble}{Character label for the internally constructed
ensemble fraction. Defaults to \code{NULL} (auto-generated).}

\item{label_sum}{Character label for the internally constructed sum
(total) fraction. Defaults to \code{NULL} (auto-generated).}

\item{quiet}{Whether to show messages.}
}
\value{
A named list of \code{pif_class} objects, one per input fraction,
where each element is \eqn{\widehat{\text{PIF}}_i^{\text{adj}}}.
Names are taken from the \code{label} slots of the input fractions.
}
\description{
Calculates the weighted adjusted potential impact fractions (or population
attributable fractions). Each individual fraction \eqn{\widehat{\text{PIF}}_i}
is rescaled proportionally so that together they are consistent with
the ensemble fraction.
}
\section{Formula}{


The weighted adjusted fraction for the \eqn{i}-th exposure is:
\deqn{
  \widehat{\text{PIF}}_i^{\text{adj}} =
    \frac{\widehat{\text{PIF}}_i}{\sum_{j=1}^{n} \widehat{\text{PIF}}_j}
    \cdot \widehat{\text{PIF}}_{\text{Ensemble}}
}

Using the log-transform, the variance is:
\deqn{
\begin{aligned}
  \operatorname{Var}\!\Big[\ln \widehat{\text{PIF}}_i^{\text{adj}}\Big]
    &= \operatorname{Var}\!\left[\ln \widehat{\text{PIF}}_i\right]
     + \operatorname{Var}\!\left[\ln \textstyle\sum_j \widehat{\text{PIF}}_j\right]
     + \operatorname{Var}\!\left[\ln \widehat{\text{PIF}}_{\text{Ensemble}}\right] \\
    &\quad + 2\Bigg[
        \operatorname{Cov}\!\Big(\ln \widehat{\text{PIF}}_i,
          \ln \widehat{\text{PIF}}_{\text{Ensemble}}\Big)
      - \operatorname{Cov}\!\Big(\ln \widehat{\text{PIF}}_i,
          \ln \textstyle\sum_j \widehat{\text{PIF}}_j\Big)
      - \operatorname{Cov}\!\Big(\ln \widehat{\text{PIF}}_{\text{Ensemble}},
          \ln \textstyle\sum_j \widehat{\text{PIF}}_j\Big)
      \Bigg]
\end{aligned}
}

where each log-covariance is approximated via the delta method:
\deqn{
  \operatorname{Cov}\!\big(\ln X, \ln Y\big) \approx
    \frac{\operatorname{Cov}(X, Y)}{X \cdot Y}
}

The covariances \eqn{\operatorname{Cov}(\widehat{\text{PIF}}_i, \cdot)} are
computed by \code{\link[=cov_total_pif]{cov_total_pif()}} applied to the individual fraction and the
internally constructed sum/ensemble objects, which automatically propagates
the full uncertainty structure already embedded in those objects.
}

\section{Internal construction}{


Internally the function builds:
\itemize{
\item A \strong{sum} fraction via \code{\link[=pif_total_class]{pif_total_class()}} with weights all equal to
\code{1}, so its \code{pif} slot equals \eqn{\sum_i \widehat{\text{PIF}}_i}.
\item An \strong{ensemble} fraction via \code{\link[=pif_ensemble]{pif_ensemble()}} / \code{\link[=paf_ensemble]{paf_ensemble()}}.
}
All cross-covariances are then computed automatically through the recursive
\code{\link[=cov_total_pif]{cov_total_pif()}} machinery that already handles atomic, total, and ensemble
fractions.
}

\examples{
\dontrun{
paf_lead <- paf(0.2, 2.2, quiet = TRUE, var_p = 0.001, label = "Lead")
paf_rad  <- paf(0.1, 1.2, quiet = TRUE, var_p = 0.0001, label = "Radiation")

# Adjusted fractions (covariances computed automatically)
adj <- weighted_adjusted_fractions(paf_lead, paf_rad)
adj$Lead
adj$Radiation

# With correlated prevalences
adj2 <- weighted_adjusted_fractions(paf_lead, paf_rad, var_p = 0.0001)
adj2$Lead
}
}
\seealso{
\code{\link[=pif_ensemble]{pif_ensemble()}}, \code{\link[=paf_ensemble]{paf_ensemble()}}, \code{\link[=cov_total_pif]{cov_total_pif()}},
\code{\link[=weighted_adjusted_paf]{weighted_adjusted_paf()}}, \code{\link[=weighted_adjusted_pif]{weighted_adjusted_pif()}}
}
\keyword{internal}
